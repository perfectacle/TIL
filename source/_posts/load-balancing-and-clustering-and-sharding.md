---
title: 로드 밸런싱과 클러스터링
date: 2018-10-14 23:00:44
tags: [Clustering]
---
처음에는 서버가 단 한 대만 있다고 가정해보자.  
DNS에는 서버의 IP를 물려놨을 것이다.  
그럼 서버가 사망하셨을 때나 트래픽이 몰렸을 때 레이턴시가 커지거나 제대로 된 응답을 받지 못한다.  
이를 위해 Load Balancing이란 기술을 사용한다.  

## Load Balancing
간단하게 서버를 두 대 두고 로드 밸런서(하드웨어/소프트웨어)를 통해 트래픽을 분산시킨다고 가정해보자.  
DNS에는 로드 밸런서의 주소를 물려놨을 것이다.  
그럼 한 대의 서버가 사망해도 장애가 발생하지 않고, 트래픽을 알고리즘에 따라 분산시키기 때문에 좀 더 레이턴시가 줄어들 것이다.  
하지만 로드 밸런서 님께서 사망하시면...?  
따라서 로드 밸런서 조차도 이중화시키고 DNS에는 그 이중화한 주소를 등록하게 된다.  

하지만 여기서 문제가 발생한다.  
HTTP는 Stateless 프로토콜이기 때문에 쿠키와 세션을 통해 State를 유지한다.  
(클라가 보낸 쿠키를 통해 서버에 저장된 세션을 가지고 와서 State를 유지...  
쿠키는 조작될 가능성이 있기 때문에 세션을 식별하기 위한 수단으로만 사용하고 암호화해서 관리해야함.)  
A란 유저의 세션이 host-1이라는 서버에 저장돼있다고 가정해보자.  
분산 알고리즘에 따라 A 유저의 요청이 host-2로 갔다고 가정해보자.  
그럼 이 유저는 로그인한 상태나 기타 등등의 정보가 유지되지 않는 것이다.  
어떤 때는 로그인 됐다고 나오고, 어떤 때는 로그인 안 됐다고 나오면 유저 입장에서는 화날 것이다.  
이럴 때 사용하는 게 Sticky Session이다.  
Sticky(끈적거리는...) 해당 세션은 끈적거려서 다른 호스트로 가는 걸 못 가게 붙잡는다는 의미 같다.  
여튼 유저 A의 요청은 처음에 해당 유저의 세션을 저장한 서버로만 간다는 걸 의미한다.  
따라서 좀 헤비한 유저는 해당 서버에 요청이 몰릴 것이므로 헤비한 유저의 세션만 따로 저장하는 서버를 둔다거나 여러가지 전략을 세우기도 한다.  

이는 샤딩에서도 마찬가지다.  
샤딩키를 가지고 분산을 잘 해야지, 잘못 분산하면 데이터가 없는 서버로 요청이 갈 수 있다.  

하지만 여기서 또 문제가 발생한다.  
유저 A의 세션을 가지고 있는 host-1이라는 서버가 사망한다고 가정해보자.  
서비스 전체에 장애는 나지 않지만, 유저 A의 세션이 유실됐으므로 로그인이나 기타 등등의 정보는 날아간다.  
유저는 갑자기 로그인이 돼있지 않는다는 황당한 오류 문구를 보게될 것이다.  
이를 위해 클러스터링이란 개념이 등장했다.  

## Clustering
클러스터는 일반적으로 무리나 (포도) 송이 등등을 일컫는다.  
데이터 분석이나 머신 러닝 쪽에서는 **유사하거나 서로 관련있는 항목끼리 묶어서 기억하려는 경향** 같은 걸로 해석한다.  
이와 유사하게 컴퓨터 사이언스 쪽에서는 **여러 대의 컴퓨터들이 연결되어 하나의 시스템처럼 동작하는 컴퓨터들의 집합** 으로 해석한다.  

cluster-1에 host-1-a, host-1-b 두 대의 서버가 존재하고,  
cluster-2에 host-2-a, host-2-b 두 대의 서버가 존재한다. (각 컴퓨터는 병렬로 연결돼있다.)  
총 4대의 서버가 존재하는 것이다.  
그리고 로드 밸런서에는 cluster-1과 cluster-2가 물려있고, dns에는 이중화된 로드 밸런서의 주소가 물려있다.  
이렇게 되면 host-1-a, host-1-b 두 대의 서버가 모두 사망하시면 어쩔 수 없겠지만...  
host-1-a만 사망하셨을 때는 A 유저의 세션이 유실되지 않는다.  

외부에서는 그냥 cluster-1만 존재하는 거지, 그 안에 어떻게 구성돼있는지는 중요하지 않다.  
클러스터 내부의 서버들 사이에서도 어떻게 복사하고 싱크를 맞출 것인지는... 굉장히 어려운 일일 것이다.  

클러스터링은 웹서버에만 적용되는 게 아니라 샤딩을 사용하는 redis, kafka 등등에도 적용된다.  
특정 데이터를 저장한 노드가 사망했을 때 클러스터링돼있다면 장애가 발생하지 않을 것이다.